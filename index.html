<!-- FORMUL√ÅRIO DE CADASTRO DE VOLUNT√ÅRIOS -->
<!-- https://defesacivil-es.github.io/Cadastro-de-Voluntarios/ -->

<!doctype html>
<html lang="pt-BR">
<head>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cadastro de Volunt√°rios</title>

  <style>
    :root {
      --cor-principal: #2B7A78;
      --cor-secundaria: #DEF2F1;
      --cor-clara: #FEFFFF;
      --cor-escura: #17252A;
    }

    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background-color: var(--cor-secundaria);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      align-items: flex-start;
    }

    /* -- inserir no <style> j√° existente -- */
    .logo {
      width: 100%;            /* ocupa toda a largura poss√≠vel */
      /*max-width: 220px;       /* mas n√£o passa de 220px */
      height: auto;           /* mant√©m a propor√ß√£o */
      display: block;
      margin: 0 auto 12px;    /* centraliza e d√° espa√ßo abaixo */
    }
    .logo-wrap {
      text-align: center;
      margin-bottom: 8px;  /* espa√ßo entre imagem e t√≠tulo */
    }

    .container {
      background: var(--cor-clara);
      border-radius: 12px;
      padding: 25px 30px;
      margin: 30px;
      width: 100%;
      max-width: 950px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    h2 {
      text-align: center;
      color: var(--cor-escura);
      margin-bottom: 20px;
    }

    fieldset {
      border: 2px solid var(--cor-principal);
      border-radius: 8px;
      margin-bottom: 18px;
      padding: 15px 20px;
    }

    legend {
      font-weight: bold;
      color: var(--cor-principal);
      padding: 0 8px;
    }

    label {
      display: block;
      font-size: 14px;
      margin-top: 10px;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-top: 4px;
      box-sizing: border-box;
    }

    /* Chrome, Edge, Opera, Safari */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Firefox */
    input[type=number] {
      -moz-appearance: textfield;
    }

    button {
      background-color: var(--cor-principal);
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      /*width: 100%;*/
      width: auto; /* <<< largura ajusta ao conte√∫do */
      display: inline-block; /* evita que ocupe 100% do espa√ßo */
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background-color: #205f5d;
    }

    #saveToSheetButton {
      background-color: #D2691E; /* laranja opaco */
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      font-size: 16px;
      width: auto; /* <<< largura ajusta ao conte√∫do */
      display: inline-block; /* evita que ocupe 100% do espa√ßo */
    }

    #saveToSheetButton:hover {
      background-color: #B85C1A; /* tom ligeiramente mais escuro no hover */
    }

    #limpaToSheetButton {
      background-color: #DC143C; /* vermelho */
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      font-size: 16px;
      width: auto; /* <<< largura ajusta ao conte√∫do */
      display: inline-block; /* evita que ocupe 100% do espa√ßo */
    }

    #limpaToSheetButton:hover {
      background-color: #B22222; /* tom ligeiramente mais escuro no hover */
    }

    .full {
      grid-column: 1 / -1; /* faz ocupar toda a linha */
    }

    .half {
      grid-column: span 1;  /* ocupa metade */
    }

    .span-2 {
      grid-column: span 2;
      width: 100%;
    }

    .botoes-container {
      display: flex;
      justify-content: center; /* bot√µes no centro */
      align-items: center;
      gap: 150px;          /* espa√ßo entre os bot√µes */
      width: 100%; /* ocupa toda a largura dispon√≠vel */
      margin-top: 10px;
    }

    #tabelaDonativos {
      width: 100%;  
      max-width: 100%; 
      box-sizing: border-box;
      /* border-collapse: separate !important;  /* permite bordas arredondadas e for√ßa modo separado */
      border-spacing: 0;          /* remove espa√ßamento entre c√©lulas */
      /*border: 2px solid #2B7A78;  /* azul petr√≥leo */
      /*border-radius: 14px;        /* arredonda o contorno da tabela */
      overflow: hidden;           /* garante visual limpo */
    }

     #status {
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
      font-size: 15px;
    }

    .quantidade-container {
     display: flex;
     align-items: center;
     gap: 8px;
    }

    .unidade-label {
     font-weight: bold;
     color: var(--cor-escura);
     white-space: nowrap;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      /*border: 1px solid #ccc;*/
      border: 1px solid #2B7A78;
      padding: 6px;
      text-align: center;
      font-size: 12px;
    }

    th {
      background-color: #87CEEB; /* azul c√©u */
      /*border: 2px solid #2B7A78; /* borda azul petr√≥leo */
      /*border-radius: 8px;        /* arredonda o contorno da tabela */
      color: white;              /* mant√©m o texto branco para contraste */
    }

    .btnExcluir {
      background-color: #c0392b;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .btnExcluir:hover {
      background-color: #922b21;
    }

    /* Reduz exatamente a altura do campo */
    .choices {
      width: 100% !important;       /* ocupa apenas a largura da coluna */
      max-width: 100% !important;   /* impede que estoure para fora */
      box-sizing: border-box !important;
      margin-top: 4px !important;
    }

    /* Ajusta a caixa interna para a mesma altura dos outros inputs */
    .choices__inner {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
      border: 1px solid #ccc !important;
      border-radius: 6px !important;
      padding: 2px 7px !important;
      min-height: 44px !important;   /* <<< ajuste principal */
      height: auto !important;       /* <<< for√ßa a altura */
      display: flex;
      /* align-items: center;           /* centraliza o texto */
      align-items: flex-start !important;
      flex-wrap: wrap;
    }

    /* Ajusta o texto interno para n√£o aumentar a altura */
    .choices__inner .choices__item {
      padding: 0 !important;
      margin: 0 !important;
      font-size: 14px !important;
      line-height: 1.2 !important;   /* <<< evita expans√£o vertical */
    }

    /* Remove espa√ßo extra no modo single */
    .choices__list--single {
      padding: 0 !important;
    }

    /* Dropdown com altura normal */
    .choices__list--dropdown {
      border-radius: 6px !important;
      border: 1px solid #ccc !important;
      margin-top: 2px !important;
    }

    @media (min-width: 700px) {
      .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px 20px;
      }
    }

    @media print {
      /* Ocultar bot√µes */
      button, .sem-imprimir {
      display: none !important;
      }

      /* Ajustar largura da p√°gina */
      body {
        margin: 20px;
        font-size: 14px;
      }
    }

    @media print {
      .no-print {
      display: none !important;
      }

      /* Opcional ‚Äî esconder tamb√©m todos os bot√µes */
      /*button { */
      /*display: none !important;*/
      /*}*/
    }    

    /* === CONTAINER PRINCIPAL === */
    .choices, #itensSelect, #itensSelect + .choices {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
      overflow: visible !important;
    }

    /* √Årea interna ajust√°vel */
    .choices__inner {
      display: flex !important;
      flex-wrap: wrap !important;
      padding: 8px !important;
      min-height: 44px !important;
      height: auto !important;
    }

    /* === GRID DAS TAGS (4 POR LINHA) === */
    .choices__list--multiple {
      display: grid !important;
      grid-template-columns: repeat(4, 1fr) !important;
      gap: 8px !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    /* Apar√™ncia das tags */
    .choices__list--multiple .choices__item {
      width: 100% !important;
      text-align: center !important;
      margin: 0 !important;
      padding: 4px 8px !important;
      font-size: 13px !important;
      border-radius: 6px !important;
      box-sizing: border-box !important;
    }

    /* === CENTRALIZA√á√ÉO DO PLACEHOLDER REAL === */
    .choices[data-type*="select-multiple"] 
    .choices__list--single 
    .choices__placeholder {
      width: 100% !important;
      text-align: center !important;
      display: block !important;
      margin: 0 auto !important;
    }

  </style>

</head>

<body>

  <div class="container">
    <div class="logo-wrap">
      <img src="Cabe√ßalho CEPDEC.PNG" alt="Logo da CepDec" class="logo">
    </div>

    <h2>Cadastro de Volunt√°rios</h2>

    <form id="formVoluntarios">
      <fieldset>
        <legend>Identifica√ß√£o do Volunt√°rio</legend>
        <div class="grid-3">

          <label>Nome do Volunt√°rio <input type="text" name="nomeVoluntario" required style="text-transform: uppercase;"></label>

          <label>CPF
            <input id="cpf" name="cpf"
                   type="text"
                   required
                   maxlength="14"
                   inputmode="numeric"
                   placeholder="000.000.000-00">
          </label>
          <label>Telefone
            <input id="telefone" name="telefone"
                   type="text"
                   required
                   maxlength="15"
                   inputmode="numeric"
                   placeholder="00 00000-0000">
          </label>
          <label>E-mail <input type="email" name="email" required></label>
          <label>Munic√≠pio
            <select id="municipioSelect" name="municipio" required>
              <option value="" disabled selected>Carregando munic√≠pios...</option>     
            </select>      
          </label>
          <label>Grau de Instru√ß√£o
            <select id="grauSelect" name="grau" required>
              <option value="" disabled selected>Carregando grau de instru√ß√£o...</option>     
            </select>      
          </label>
          <label>Forma√ß√£o
            <select id="formacaoSelect" name="formacao" required>
              <option value="" disabled selected>Carregando forma√ß√£o...</option>     
            </select>      
          </label>
          <label class = "span-2">Trabalho Volunt√°rio Oferecido <input type="text" name="trabalhoOferecido" required></label>
          <label class = "full">Itens que Disponibiliza para o Servi√ßo Volunt√°rio
            <select id="itensSelect" name="itens" multiple>
              <option value="" disabled selected>Carregando itens...</option>     
            </select>      
          </label>
          <label class = "full">Informa√ß√µes Complementares <input type="text" name="informacao" ></label>

        </div>
      </fieldset>

      <div class="botoes-container">
        <button type="button" id="saveToSheetButton" >Registrar Volunt√°rio</button>
        <button type="button" id="limpaToSheetButton" onclick="limparFormulario()" >Limpar Formul√°rio</button>
      </div>

      <div id="status" class="message"></div>

    </form>

  </div>

<script>
  const appScriptUrl = 'https://script.google.com/macros/s/AKfycbyHfRkN-yAvFPHDnn4n83gCPftr0fkY4EJfPt6OoT-7pEkgqgMw2VwBHgUv4NHixJdj/exec';
  let lookupData = {};

  const form = document.getElementById('formVoluntarios');
  const saveBtn = document.getElementById('saveToSheetButton');
  const statusArea = document.getElementById('status');


  const cpfInput = document.getElementById('cpf');
  cpfInput.addEventListener('input', function () {
    // Remove tudo que n√£o for n√∫mero
    let valor = this.value.replace(/\D/g, '');

    // Limita a 11 d√≠gitos
    valor = valor.substring(0, 11);

    // Aplica a m√°scara
    if (valor.length > 9) {
      valor = valor.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
    } else if (valor.length > 6) {
      valor = valor.replace(/(\d{3})(\d{3})(\d{1,3})/, "$1.$2.$3");
    } else if (valor.length > 3) {
      valor = valor.replace(/(\d{3})(\d{1,3})/, "$1.$2");
    }

    this.value = valor;
  });

  const telInput = document.getElementById('telefone');
  telInput.addEventListener('input', function () {
    // Remove tudo que n√£o for n√∫mero
    let valor = this.value.replace(/\D/g, '');

    // Limita a 11 d√≠gitos
    valor = valor.substring(0, 11);

    // Aplica a m√°scara
    if (valor.length > 6) {
      // Formato celular: 00 00000-0000
      valor = valor.replace(/(\d{2})(\d{5})(\d{4})/, "$1 $2-$3");
    } else if (valor.length > 2) {
      // In√≠cio do formato fixo: 00 0000-0000
      valor = valor.replace(/(\d{2})(\d{1,4})/, "$1 $2");
    }

    this.value = valor;
  });


  // ‚≠ê ADICIONADO ‚Äî inst√¢ncia global do Choices
  let itensChoices = null;

  async function fetchLookupData() {
    const lookupUrl = `${appScriptUrl}?action=lookup`;

    try {
      const res = await fetch(lookupUrl);
      const json = await res.json();
      const data = json.data || json;

      lookupData = data;

      if (document.getElementById('municipioSelect'))
        populateSelect(document.getElementById('municipioSelect'), lookupData.municipio || []);

      if (document.getElementById('grauSelect'))
        populateSelect(document.getElementById('grauSelect'), lookupData.grau || []);

      if (document.getElementById('formacaoSelect'))
        populateSelect(document.getElementById('formacaoSelect'), lookupData.formacao || []);

      //if (document.getElementById('itensSelect'))
      //  populateSelect(document.getElementById('itensSelect'), lookupData.itens || []);

      // ‚≠ê ALTERADO ‚Äì Agora N√ÉO usa populateSelect() no itensSelect
      if (document.getElementById('itensSelect')) {

        // Ativar Choices APENAS 1 vez
        itensChoices = new Choices('#itensSelect', {
          removeItemButton: true,
          searchPlaceholderValue: "Buscar item...",
          placeholderValue: "Selecione os itens...",
          noResultsText: "Nenhum item encontrado",
          itemSelectText: "",
        });

        // ‚≠ê FECHAR DROPDOWN AP√ìS CADA SELE√á√ÉO
        document.querySelector('#itensSelect').addEventListener('change', () => {
          itensChoices.hideDropdown();
        });

        // ‚≠ê MOSTRAR DROPDOWN AO CLICAR NO CAMPO
        const container = document.querySelector('#itensSelect').closest('.choices');
        container.addEventListener('click', () => {
          itensChoices.showDropdown();
        });

        // ‚≠ê ADICIONADO ‚Äî carregar itens direto no Choices
        populateSelectChoices(itensChoices, lookupData.itens || []);
      }      

    } catch (e) {
      console.error(e);
    }
  }

  function populateSelect(select, items){
    
    // Se o select for m√∫ltiplo, N√ÉO usar uma op√ß√£o "Selecione..."
    if (select.multiple) {
      select.innerHTML = '';  // limpa tudo
    } else {
      // select normal ‚Üí OK manter placeholder
      select.innerHTML = '<option value="" disabled selected>Selecione...</option>';
    }

    items.forEach(i => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i;
      select.appendChild(opt);
    });
  }

  // ‚≠ê ADICIONADO ‚Äì Fun√ß√£o apropriada para Choices.js
  function populateSelectChoices(choicesInstance, items) {
    const list = items.map(i => ({ value: i, label: i }));
    choicesInstance.clearStore();
    choicesInstance.setChoices(list, 'value', 'label', true);
  }

  // üîπ Agora N√ÉO √© mais lote ‚Äî salva 1 registro por vez
  saveBtn.addEventListener('click', async () => {

    // üî∏ Valida√ß√£o autom√°tica dos campos required
    if (!form.checkValidity()) {
      form.reportValidity(); // mostra os erros na tela
      return; // interrompe o envio
    }

    statusArea.textContent = "Salvando Registro de Volunt√°rio...";
    saveBtn.disabled = true;

    try {
      const formData = new FormData(form);

      // for√ßa nome em mai√∫sculas
      formData.set('nomeVoluntario',
        formData.get('nomeVoluntario').toUpperCase()
      );

      // obter selecionados
      //const itensSelecionados = [...document.getElementById('itensSelect').selectedOptions]
      //  .map(o => o.value);

      // ‚≠ê ALTERADO ‚Äî capturar itens do Choices
      const itensSelecionados = itensChoices.getValue(true); 

      // salvar como string separada por v√≠rgula
      formData.set('itens', itensSelecionados.join(", "));

      // üî∏ Envio de Dados para o Apps Script que precisa identificar a a√ß√£o:
      formData.append('action', 'saveOne');

      const response = await fetch(appScriptUrl, {
        method: "POST",
        body: formData
      });

      const result = await response.json();

      if (result.status === 'SUCCESS') {
        statusArea.textContent = "‚úÖ Registro salvo!";
        setTimeout(() => { statusArea.textContent = ""; }, 3000);
      } else {
        statusArea.textContent = "‚ö†Ô∏è Erro: " + result.message;
        setTimeout(() => { statusArea.textContent = ""; }, 7000);
      }

    } catch (err) {
      statusArea.textContent = "‚ùå Falha: " + err.message;
    }

    finally {
      saveBtn.disabled = false;
    }

    form.reset();

    // ‚≠ê ADICIONADO ‚Äî limpar visual do Choices tamb√©m
    if (itensChoices) itensChoices.removeActiveItems();

  });

  function limparFormulario() {
    // 1. Limpa todos os campos <input> e <select>
    const form = document.querySelector('form'); // Supondo que seus campos estejam dentro de uma tag <form>
    if (form) {
        form.reset(); // M√©todo nativo que limpa a maioria dos campos do formul√°rio
    }

    // ‚≠ê ADICIONADO ‚Äî limpar Choices
    if (itensChoices) itensChoices.removeActiveItems();
  }

  document.addEventListener("DOMContentLoaded", fetchLookupData);

</script>

</body>

</html>




